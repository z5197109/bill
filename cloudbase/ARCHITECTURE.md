# CloudBase 架构说明

## 🏗️ 简化后的架构

### 原架构 vs 新架构

**原架构（复杂）：**
```
小程序 → 上传图片到云存储 → 云函数读取文件 → OCR识别 → 存储结果 → 返回
```

**新架构（简化）：**
```
小程序 → 直接传递图片base64 → OCR云函数 → 直接返回识别结果
```

## 📦 云函数服务

### 核心服务
1. **user-service** - 用户管理
   - 微信登录
   - 用户信息管理
   - 权限验证

2. **ledger-service** - 账本管理
   - 账本 CRUD 操作
   - 默认账本设置
   - 权限控制

3. **bill-service** - 账单管理
   - 账单 CRUD 操作
   - 批量操作
   - 统计功能

4. **ocr-service** - OCR 识别（新增）
   - 直接处理图片 base64
   - 智能解析商户、金额、日期
   - 自动分类建议
   - 批量处理支持

5. **analytics-service** - 数据分析
   - 消费统计
   - 趋势分析
   - 数据导出

6. **config-service** - 配置管理
   - 分类管理
   - 规则管理
   - 默认配置

## 🚀 架构优势

### 1. 性能提升
- **无文件存储开销**：直接处理图片数据，无需上传下载
- **减少网络请求**：一次请求完成识别
- **更快响应**：省去文件 I/O 操作

### 2. 成本降低
- **无存储费用**：不需要云存储空间
- **减少函数调用**：合并文件处理和 OCR 识别
- **带宽节省**：避免重复传输

### 3. 架构简化
- **更少的服务**：从 file-service + ocr-service 合并为 ocr-service
- **更简单的流程**：直接的数据流
- **更容易维护**：减少组件间依赖

### 4. 用户体验
- **更快的识别**：实时处理，无需等待上传
- **批量处理**：支持一次处理多张图片
- **离线友好**：图片可以本地缓存处理

## 📱 小程序集成

### 使用方式
```javascript
// 单张图片识别
const result = await api.processImageOCR(imageBase64, ledgerId)

// 批量图片识别
const results = await api.batchProcessImages(images, ledgerId)

// 获取服务状态
const status = await api.getOCRStatus()
```

### 数据流
```
1. 用户选择图片
2. 小程序读取为 base64
3. 调用 ocr-service 云函数
4. 返回解析结果和分类建议
5. 用户确认后保存为账单
```

## 🔧 技术特性

### OCR 识别能力
- **智能解析**：自动识别商户名、金额、日期
- **分类建议**：基于规则自动推荐分类
- **置信度评估**：提供识别准确度
- **错误处理**：优雅处理识别失败

### 扩展性
- **多 OCR 提供商**：支持腾讯云 OCR 或自定义服务
- **规则引擎**：可配置的分类规则
- **批量处理**：支持多图片并发识别
- **缓存机制**：可添加识别结果缓存

## 🛠️ 部署和维护

### 部署命令
```bash
# 部署 OCR 服务
cloudbase fn deploy ocr-service -e dev-4g40wh23d397fbae --dir functions/ocr-service

# 查看所有服务
cloudbase fn list -e dev-4g40wh23d397fbae
```

### 监控指标
- **识别成功率**：OCR 识别的准确性
- **响应时间**：从请求到返回结果的时间
- **并发处理**：同时处理的请求数量
- **错误率**：识别失败的比例

## 🔮 未来优化

### 可能的改进
1. **AI 增强**：使用机器学习提高识别准确率
2. **模板识别**：针对特定商户的票据模板
3. **实时预览**：在识别过程中显示实时结果
4. **离线识别**：支持本地 OCR 引擎

### 性能优化
1. **结果缓存**：缓存相似图片的识别结果
2. **预处理**：图片压缩和格式优化
3. **并发控制**：限制同时处理的图片数量
4. **负载均衡**：多实例部署和请求分发

这个新架构大大简化了系统复杂度，提高了性能，降低了成本，同时保持了所有核心功能。